#!/bin/bash

# CACHE EXISTING ENVIRONMENT VARIABLES

LOCAL_GREP_AFTER=$GREP_AFTER
LOCAL_GREP_BEFORE=$GREP_BEFORE
LOCAL_GREP_BINARY=$GREP_BINARY
LOCAL_GREP_COLOR=$GREP_COLOR
LOCAL_GREP_FILENAME=$GREP_FILENAME
LOCAL_GREP_GROUPS=$GREP_GROUPS
LOCAL_GREP_LINENUM=$GREP_LINENUM
LOCAL_GREP_NOCASE=$GREP_NOCASE
LOCAL_GREP_QUIET=$GREP_QUIET
LOCAL_GREP_REGEX_EXT=$GREP_REGEX_EXT
LOCAL_GREP_EXCLUDE_DIRS=$GREP_EXCLUDE_DIRS
LOCAL_GREP_EXCLUDE_FILE=$GREP_EXCLUDE_FILE
LOCAL_GREP_EXCLUDE_PATTERN=$GREP_EXCLUDE_PATTERN

# LOAD IN GLOBAL FOLDER

[[ -f "${HOME}/.greprc" ]] && . "${HOME}/.greprc"

# LOAD IN CURRENT FOLDER

[[ -f "${PWD}/.greprc" ]] && . "${PWD}/.greprc"

# RESET ANY ENIRONMENT VARIABLES TO THEIR CORRECT VALUE

[[ ! -z $LOCAL_GREP_AFTER ]] && GREP_AFTER=$LOCAL_GREP_AFTER
[[ ! -z $LOCAL_GREP_BEFORE ]] && GREP_BEFORE=$LOCAL_GREP_BEFORE
[[ ! -z $LOCAL_GREP_BINARY ]] && GREP_BINARY=$LOCAL_GREP_BINARY
[[ ! -z $LOCAL_GREP_COLOR ]] && GREP_COLOR=$LOCAL_GREP_COLOR
[[ ! -z $LOCAL_GREP_FILENAME ]] && GREP_FILENAME=$LOCAL_GREP_FILENAME
[[ ! -z $LOCAL_GREP_GROUPS ]] && GREP_GROUPS=$LOCAL_GREP_GROUPS
[[ ! -z $LOCAL_GREP_LINENUM ]] && GREP_LINENUM=$LOCAL_GREP_LINENUM
[[ ! -z $LOCAL_GREP_NOCASE ]] && GREP_NOCASE=$LOCAL_GREP_NOCASE
[[ ! -z $LOCAL_GREP_QUIET ]] && GREP_QUIET=$LOCAL_GREP_QUIET
[[ ! -z $LOCAL_GREP_REGEX_EXT ]] && GREP_REGEX_EXT=$LOCAL_GREP_REGEX_EXT
[[ ! -z $LOCAL_GREP_EXCLUDE_DIRS ]] && GREP_EXCLUDE_DIRS=$LOCAL_GREP_EXCLUDE_DIRS
[[ ! -z $LOCAL_GREP_EXCLUDE_PATTERN ]] && GREP_EXCLUDE_PATTERN=$LOCAL_GREP_EXCLUDE_PATTERN
[[ ! -z $LOCAL_GREP_EXCLUDE_FILE ]] && GREP_EXCLUDE_FILE=$LOCAL_GREP_EXCLUDE_FILE



# SETUP GENERAL FLAGS

GREP_FLAGS=""

if [ "$GREP_COLOR" == "yes" ];  then
  GREP_FLAGS="$GREP_FLAGS --color=always"
fi

if [ "$GREP_NOCASE" == "yes" ]; then
  GREP_FLAGS="$GREP_FLAGS --ignore-case"
fi

if [ "$GREP_REGEX_EXT" == "yes" ]; then
  GREP_FLAGS="$GREP_FLAGS --extended-regexp"
fi

if [ "$GREP_QUIET" == "yes" ]; then
  GREP_FLAGS="$GREP_FLAGS --no-messages"
fi

if [ "$GREP_GROUPS" == "no" ]; then
  GREP_FLAGS="$GREP_FLAGS --no-group-separator"
fi


[[ "$GREP_BINARY" == "yes" ]] && GREP_FLAGS="$GREP_FLAGS --text"

[[ ! -z $GREP_BEFORE ]] && GREP_FLAGS="$GREP_FLAGS --before-context=$GREP_BEFORE"

[[ ! -z $GREP_AFTER ]] && GREP_FLAGS="$GREP_FLAGS --after-context=$GREP_AFTER"

GREP_FLAGS="$GREP_FLAGS "

# APPLY FLAGS FOR PROCESS NOT A PIPE

GREP_COMMAND_ARGUMENTS="$@"

if [ -t 0 ]; then

  GREP_RUNTIME_FLAGS=""

  # APPLY RUNTIME ONLY FLAGS

  GREP_RUNTIME_FLAGS=""

  if [ "$GREP_LINENUM" == "yes" ]; then
    GREP_RUNTIME_FLAGS="$GREP_RUNTIME_FLAGS --line-number"
  fi

  if [ "$GREP_FILENAME" == "yes" ]; then
    GREP_RUNTIME_FLAGS="$GREP_RUNTIME_FLAGS --with-filename"
  else
    GREP_RUNTIME_FLAGS="$GREP_RUNTIME_FLAGS --no-filename"
  fi

  # SET FILE EXCLUSION FLAGS

  [[ -v GREP_EXCLUDE_FILE ]] && \
      [[ -f $GREP_EXCLUDE_FILE ]] && \
      GREP_RUNTIME_FLAGS="${GREP_RUNTIME_FLAGS} --exclude-from=${GREP_EXCLUDE_FILE}"

  [[ -v GREP_EXCLUDE_DIRS ]] && \
      GREP_RUNTIME_FLAGS="${GREP_RUNTIME_FLAGS} --exclude-dir=${GREP_EXCLUDE_DIRS//,/ --exclude-dir=}"

  [[ -v GREP_EXCLUDE_PATTERN ]] && \
      GREP_RUNTIME_FLAGS="${GREP_RUNTIME_FLAGS} --exclude=${GREP_EXCLUDE_PATTERN//,/ --exclude=}"


  GREP_RUNTIME_FLAGS="$GREP_RUNTIME_FLAGS --recursive "

fi

# ORDER OF PRECIDENCE
# - GENERAL USER LOCAL ENV FIRS
# - RUNTIME SPECIFIC FLAGS
# - COMMANDLINE INPUT

GREP_EXECUTION_STRING="${GREP_FLAGS}${GREP_RUNTIME_FLAGS}${GREP_COMMAND_ARGUMENTS}"

grep $GREP_EXECUTION_STRING


if [ "$GREP_DEBUG" == "yes" ]; then
  echo -e "\n------------------------\n\tdone\n------------------------"
  echo -e "\n  [COMMAND]\n\n  grep $GREP_EXECUTION_STRING\n"
  echo -e "\n  [GREP_FLAGS]  Set in env or .greprc file"
  echo -e "\n\t${GREP_FLAGS}"
  echo -e "\n  [GREP_RUNTIME_FLAGS]  Conditional flags set based on the conditions at runtime"
  echo -e "\n\t${GREP_RUNTIME_FLAGS}"
  echo -e "\n  [GREP_COMMAND_ARGUMENTS]  Arguments set at the commandline during execution"
  echo -e "\n\t${GREP_COMMAND_ARGUMENTS}\n"
fi


# CLEANUP TEMP VARS
unset GREP_FLAGS
unset EXCLUDE_FLAGS
unset GREP_COMMAND_ARGUMENTS
unset GREP_RUNTIME_FLAGS
unset GREP_EXECUTION_STRING
unset LOCAL_GREP_AFTER
unset LOCAL_GREP_BEFORE
unset LOCAL_GREP_BINARY
unset LOCAL_GREP_COLOR
unset LOCAL_GREP_FILENAME
unset LOCAL_GREP_GROUPS
unset LOCAL_GREP_LINENUM
unset LOCAL_GREP_NOCASE
unset LOCAL_GREP_QUIET
unset LOCAL_GREP_REGEX_EXT
unset LOCAL_GREP_EXCLUDE_DIRS
unset LOCAL_GREP_EXCLUDE_PATTERN
unset LOCAL_GREP_EXCLUDE_FILE
